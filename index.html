<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>உள்ளூர் பட தேடல் ஆப் (Offline Image Search App)</title>
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3498db">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="உள்ளூர் பட தேடல்">
    <!-- Inline Manifest (Single File) -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjogIuCuieCus+CvjeCus+CvguCusOCvjSDgrqrgrp8g4K6k4K+H4K6f4K6y4K+NIOCuhuCuquCvjSIsICJzaG9ydF9uYW1lIjogIuCuieCus+CvjeCus+CvguCusOCvjSDgrqrgrp8g4K6k4K+H4K6f4K6y4K+NIiwgImRlc2NyaXB0aW9uIjogIuCuhuCug+CuquCvjeCusuCviOCuqeCvjSDgrqrgrp8g4K6a4K+H4K6u4K6/4K6q4K+N4K6q4K+BIOCuruCuseCvjeCuseCvgeCuruCvjSDgrqTgr4fgrp/grrLgr40g4K6G4K6q4K+NIiwgInN0YXJ0X3VybCI6ICIvIiwgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmNGY0ZjQiLCAidGhlbWVfY29sb3IiOiAiIzM0OThkYiJ9">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .upload-section, .search-section {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        input[type="file"], input[type="text"] {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 200px;
        }

        button {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        .download-all-btn {
            background-color: #e74c3c;
        }

        .download-all-btn:hover {
            background-color: #c0392b;
        }

        .download-btn {
            background-color: #27ae60;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin: 2px;
            width: 48%;
        }

        .download-btn:hover {
            background-color: #229954;
        }

        .delete-btn {
            background-color: #e74c3c;
            width: 48%;
        }

        .delete-btn:hover {
            background-color: #c0392b;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .image-item {
            background: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
        }

        .image-item img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            max-height: 150px;
        }

        .image-item .filename {
            margin: 5px 0;
            font-size: 12px;
            color: #666;
            word-break: break-word;
        }

        .image-item .tags {
            margin: 5px 0;
            font-size: 11px;
            color: #7f8c8d;
            word-break: break-word;
        }

        .image-item .btn-group {
            display: flex;
            gap: 2px;
        }

        .search-group {
            margin-bottom: 30px;
            padding: 15px;
            background: #ecf0f1;
            border-radius: 8px;
        }

        .search-group h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .status {
            margin-top: 20px;
            font-style: italic;
            color: #7f8c8d;
            font-size: 14px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .gallery {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            input[type="file"], input[type="text"] {
                width: 100%;
            }
            .image-item .btn-group {
                flex-direction: column;
            }
            .download-btn, .delete-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>உள்ளூர் பட தேடல் ஆப்</h1>
        
        <div class="upload-section">
            <input type="file" id="fileInput" accept="image/*" multiple webkitdirectory>
            <button id="uploadBtn">ஃபோல்டர் அல்லது படங்கள் பதிவேற்று (Upload Folder/Images)</button>
        </div>
        
        <div class="search-section">
            <input type="text" id="searchInput" placeholder="படத்தின் பெயரால் அல்லது டேக்குகளால் தேடவும்... (எ.கா. Shubman OR cricket)">
            <button id="clearSearchBtn">தேடலை அழி (Clear Search)</button>
            <button id="downloadAllBtn" class="download-all-btn hidden">அனைத்து தேடல் முடிவுகளையும் பதிவிறக்கு (Download All)</button>
        </div>
        
        <div id="gallery" class="gallery"></div>
        <p id="status" class="status"></p>
    </div>

    <script>
        // Inline PWA Service Worker Registration (Single File)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                const swCode = `
                    const CACHE_NAME = 'image-search-app-v5';
                    const urlsToCache = ['/'];

                    self.addEventListener('install', (event) => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then((cache) => cache.addAll(urlsToCache))
                        );
                    });

                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request)
                                .then((response) => response || fetch(event.request))
                        );
                    });
                `;
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                try {
                    const registration = await navigator.serviceWorker.register(swUrl);
                    console.log('SW registered: ', registration);
                } catch (error) {
                    console.log('SW registration failed: ', error);
                }
            });
        }

        // StorageManager Class
        class StorageManager {
            constructor() {
                this.dbName = 'ImageSearchDB';
                this.storeName = 'images';
                this.db = null;
                this.initDB();
            }

            initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, 2);

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve();
                    };

                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            const store = db.createObjectStore(this.storeName, { keyPath: 'id', autoIncrement: true });
                            store.createIndex('filename', 'filename', { unique: false });
                            store.createIndex('tags', 'tags', { unique: false });
                        } else {
                            const store = request.transaction.objectStore(this.storeName);
                            if (!store.indexNames.contains('tags')) {
                                store.createIndex('tags', 'tags', { unique: false });
                            }
                        }
                    };
                });
            }

            async addImage(blob, filename, tags = []) {
                await this.initDB();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.add({ blob, filename, tags });

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getAllImages() {
                await this.initDB();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getImageById(id) {
                await this.initDB();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.get(id);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async deleteImage(id) {
                await this.initDB();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.delete(id);

                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }
        }

        // ImageHandler Class
        class ImageHandler {
            constructor(storage) {
                this.storage = storage;
                this.galleryElement = document.getElementById('gallery');
            }

            async uploadImages(files) {
                const uploadBtn = document.getElementById('uploadBtn');
                const status = document.getElementById('status');
                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<span class="loading"></span>பதிவேற்றுகிறோம்...';
                status.textContent = 'படங்கள் பதிவேற்றப்படுகின்றன...';

                const promises = Array.from(files).map(async (file) => {
                    if (!file.type.startsWith('image/')) return;
                    const reader = new FileReader();
                    reader.readAsArrayBuffer(file);
                    return new Promise((resolve) => {
                        reader.onload = async () => {
                            const blob = new Blob([reader.result], { type: file.type });
                            // Use relative path as filename for folder structure
                            const filename = file.webkitRelativePath || file.name;
                            const tagsInput = prompt('இந்த படத்துக்கு டேக்குகளை உள்ளிடவும் (காமா உடன் பிரி, விரும்பாவிட்டால் Enter அழுத்தவும்): ' + filename);
                            const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];
                            await this.storage.addImage(blob, filename, tags);
                            resolve();
                        };
                    });
                });
                await Promise.all(promises);

                uploadBtn.disabled = false;
                uploadBtn.innerHTML = 'ஃபோல்டர் அல்லது படங்கள் பதிவேற்று (Upload Folder/Images)';
                status.textContent = `${files.length} படங்கள் சேமிக்கப்பட்டன!`;
            }

            async loadImages() {
                const images = await this.storage.getAllImages();
                this.galleryElement.innerHTML = '';
                images.forEach((image) => {
                    this.createImageElement(image);
                });
                document.getElementById('downloadAllBtn').classList.add('hidden');
            }

            createImageElement(imageData, groupTitle = null) {
                const item = document.createElement('div');
                item.className = 'image-item';

                const img = document.createElement('img');
                const url = URL.createObjectURL(imageData.blob);
                img.src = url;
                img.alt = imageData.filename;
                img.onload = () => URL.revokeObjectURL(url);

                const filenameSpan = document.createElement('div');
                filenameSpan.className = 'filename';
                filenameSpan.textContent = imageData.filename;

                const tagsSpan = document.createElement('div');
                tagsSpan.className = 'tags';
                tagsSpan.textContent = imageData.tags.length > 0 ? '#' + imageData.tags.join(' #') : 'இல்லை (No tags)';

                const btnGroup = document.createElement('div');
                btnGroup.className = 'btn-group';

                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'download-btn';
                downloadBtn.textContent = 'பதிவிறக்கு';
                downloadBtn.addEventListener('click', () => this.downloadImage(imageData.id));

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'download-btn delete-btn';
                deleteBtn.textContent = 'அழி';
                deleteBtn.addEventListener('click', () => this.deleteImage(imageData.id, item));

                btnGroup.appendChild(downloadBtn);
                btnGroup.appendChild(deleteBtn);

                item.appendChild(img);
                item.appendChild(filenameSpan);
                item.appendChild(tagsSpan);
                item.appendChild(btnGroup);
                item.dataset.filename = imageData.filename.toLowerCase();
                item.dataset.tags = imageData.tags.join(' ').toLowerCase();
                item.dataset.id = imageData.id;

                return item;
            }

            async downloadImage(id) {
                try {
                    const image = await this.storage.getImageById(id);
                    if (image) {
                        const url = URL.createObjectURL(image.blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = image.filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }
                } catch (error) {
                    console.error('Download error:', error);
                    alert('பதிவிறக்கு பிழை: ' + error.message);
                }
            }

            async deleteImage(id, itemElement) {
                if (!confirm('இந்த படத்தை அழிக்க விரும்புகிறீர்களா?')) return;
                try {
                    await this.storage.deleteImage(id);
                    itemElement.remove();
                    document.getElementById('status').textContent = 'படம் அழிக்கப்பட்டது.';
                } catch (error) {
                    alert('அழிப்பு பிழை: ' + error.message);
                }
            }

            async downloadAll() {
                const items = document.querySelectorAll('.image-item');
                if (items.length === 0) {
                    alert('தேடல் முடிவுகள் இல்லை.');
                    return;
                }
                const status = document.getElementById('status');
                status.innerHTML = '<span class="loading"></span>அனைத்தையும் பதிவிறக்குகிறோம்...';
                try {
                    for (let item of items) {
                        const id = parseInt(item.dataset.id);
                        const image = await this.storage.getImageById(id);
                        if (image) {
                            const url = URL.createObjectURL(image.blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = image.filename;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                            await new Promise(resolve => setTimeout(resolve, 300));
                        }
                    }
                    status.textContent = `${items.length} படங்கள் பதிவிறக்கப்பட்டன!`;
                } catch (error) {
                    status.textContent = 'பதிவிறக்கு பிழை: ' + error.message;
                }
            }

            displayGroupedImages(groupedImages) {
                this.galleryElement.innerHTML = '';
                let hasResults = false;
                Object.entries(groupedImages).forEach(([term, images]) => {
                    if (images.length > 0) {
                        hasResults = true;
                        const groupDiv = document.createElement('div');
                        groupDiv.className = 'search-group';

                        const title = document.createElement('h3');
                        title.textContent = `தேடல்: "${term}" (${images.length} படங்கள்)`;
                        groupDiv.appendChild(title);

                        const groupGallery = document.createElement('div');
                        groupGallery.className = 'gallery';

                        images.sort((a, b) => a.filename.localeCompare(b.filename));

                        images.forEach((image) => {
                            const item = this.createImageElement(image, term);
                            groupGallery.appendChild(item);
                        });

                        groupDiv.appendChild(groupGallery);
                        this.galleryElement.appendChild(groupDiv);
                    }
                });

                const downloadAllBtn = document.getElementById('downloadAllBtn');
                if (hasResults) {
                    downloadAllBtn.classList.remove('hidden');
                } else {
                    downloadAllBtn.classList.add('hidden');
                }
            }
        }

        // SearchManager Class
        class SearchManager {
            constructor(imageHandler) {
                this.imageHandler = imageHandler;
                this.searchInput = document.getElementById('searchInput');
                this.allImages = [];
                this.initSearch();
            }

            initSearch() {
                this.searchInput.addEventListener('input', (e) => {
                    this.filterImages(e.target.value.toLowerCase().trim());
                });
            }

            async filterImages(query) {
                if (!query) {
                    await this.imageHandler.loadImages();
                    return;
                }

                const terms = query.split(/\s+/).filter(term => term.length > 0);
                if (terms.length === 0) {
                    await this.imageHandler.loadImages();
                    return;
                }

                const groupedImages = {};
                terms.forEach(term => {
                    groupedImages[term] = [];
                });

                this.allImages.forEach((image) => {
                    const filenameLower = image.filename.toLowerCase();
                    const tagsLower = image.tags.join(' ').toLowerCase();
                    terms.forEach((term) => {
                        if (filenameLower.includes(term) || tagsLower.includes(term)) {
                            groupedImages[term].push(image);
                        }
                    });
                });

                this.imageHandler.displayGroupedImages(groupedImages);
            }

            setAllImages(images) {
                this.allImages = images;
            }
        }

        // Main App Class
        class ImageSearchApp {
            constructor() {
                this.storage = new StorageManager();
                this.imageHandler = new ImageHandler(this.storage);
                this.searchManager = new SearchManager(this.imageHandler);
                this.init();
            }

            async init() {
                const images = await this.storage.getAllImages();
                this.searchManager.setAllImages(images);
                await this.imageHandler.loadImages();
                this.attachEventListeners();
                this.updateStatus('ஆப் தயார்! படங்களை பதிவேற்றவும்.');
            }

            attachEventListeners() {
                const fileInput = document.getElementById('fileInput');
                const uploadBtn = document.getElementById('uploadBtn');
                const clearSearchBtn = document.getElementById('clearSearchBtn');
                const downloadAllBtn = document.getElementById('downloadAllBtn');

                uploadBtn.addEventListener('click', () => this.handleUpload(fileInput.files));
                clearSearchBtn.addEventListener('click', () => this.clearSearch());
                downloadAllBtn.addEventListener('click', () => this.imageHandler.downloadAll());
            }

            async handleUpload(files) {
                if (!files.length) return;
                await this.imageHandler.uploadImages(files);
                const allImages = await this.storage.getAllImages();
                this.searchManager.setAllImages(allImages);
                await this.imageHandler.loadImages();
                this.searchManager.filterImages('');
            }

            clearSearch() {
                document.getElementById('searchInput').value = '';
                this.searchManager.filterImages('');
                document.getElementById('downloadAllBtn').classList.add('hidden');
            }

            updateStatus(message) {
                document.getElementById('status').textContent = message;
            }
        }

        // Initialize app
        new ImageSearchApp();
    </script>
</body>
</html>
