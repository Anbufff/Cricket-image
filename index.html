<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡Æ™‡Æü‡Æ§‡Øç ‡Æ§‡Øá‡Æü‡Æ≤‡Øç ‡ÆÜ‡Æ™‡Øç</title>
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }

        h1 {
            color: white;
            margin: 10px 0 15px;
            font-size: 22px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .stats-bar {
            background: rgba(255,255,255,0.95);
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-flex;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 13px;
            font-weight: 600;
            color: #2c3e50;
        }

        .section {
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .section-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        input[type="file"] { display: none; }

        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 12px 15px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: white;
            width: 100%;
            margin-bottom: 8px;
            transition: transform 0.2s, opacity 0.2s;
        }

        .btn:active { transform: scale(0.95); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .btn-danger { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
        .btn-warning { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); }
        .btn-purple { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); }
        .btn-teal { background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%); }
        .btn:disabled { background: #bdc3c7 !important; cursor: not-allowed; opacity: 0.7; }

        .btn-row { display: flex; gap: 8px; }
        .btn-row .btn { flex: 1; margin: 0; }

        .btn-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .btn-grid .btn { margin: 0; }

        .search-box {
            position: relative;
            margin-bottom: 10px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 40px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 14px;
        }

        .search-box input:focus { outline: none; border-color: #667eea; }
        .search-box::before { content: "üîç"; position: absolute; left: 15px; top: 50%; transform: translateY(-50%); }

        .search-box .clear-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: none;
        }
        .search-box .clear-btn.show { display: block; }

        .search-hint {
            font-size: 10px;
            color: #888;
            margin-top: 5px;
            text-align: left;
            padding-left: 10px;
        }

        .search-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
            justify-content: center;
        }

        .search-tag {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .search-tag .remove {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .image-item {
            background: white;
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .image-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
        }

        .image-item .filename {
            margin: 6px 0;
            font-size: 10px;
            color: #2c3e50;
            word-break: break-all;
            font-weight: 600;
            background: #e8f5e9;
            padding: 5px;
            border-radius: 4px;
        }

        .image-item .btn-group {
            display: flex;
            gap: 4px;
        }

        .image-item .btn-group .btn {
            flex: 1;
            padding: 6px;
            font-size: 12px;
            margin: 0;
        }

        .search-group {
            margin-bottom: 20px;
            padding: 12px;
            background: rgba(255,255,255,0.95);
            border-radius: 12px;
        }

        .search-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .search-group h3 {
            color: #2c3e50;
            margin: 0;
            font-size: 14px;
        }

        .search-group .count-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
        }

        .search-group .download-group-btn {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 11px;
            cursor: pointer;
        }

        .status {
            margin-top: 15px;
            font-size: 13px;
            color: white;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }

        .hidden { display: none !important; }

        .selected-info {
            background: #e3f2fd;
            color: #1565c0;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            margin-top: 10px;
        }

        .progress-bar {
            background: #ecf0f1;
            border-radius: 10px;
            height: 10px;
            overflow: hidden;
            margin: 10px 0 5px;
        }

        .progress-fill {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            height: 100%;
            transition: width 0.3s;
        }

        .progress-fill.backup { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); }
        .progress-fill.restore { background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%); }

        .progress-text { font-size: 11px; color: #666; }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 15px;
        }
        .modal.show { display: flex; }

        .modal-close {
            position: absolute;
            top: 10px; right: 15px;
            color: white;
            font-size: 28px;
            cursor: pointer;
            background: rgba(0,0,0,0.5);
            width: 40px; height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal img {
            max-width: 100%;
            max-height: 60%;
            object-fit: contain;
            border-radius: 8px;
        }

        .modal-filename {
            color: white;
            background: rgba(0,0,0,0.6);
            padding: 10px 15px;
            border-radius: 10px;
            margin-top: 10px;
            font-size: 12px;
            word-break: break-all;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .modal-actions .btn { width: auto; padding: 10px 20px; }

        .upload-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            justify-content: center;
            align-items: center;
            padding: 15px;
        }
        .upload-modal.show { display: flex; }

        .upload-modal-content {
            background: white;
            padding: 20px;
            border-radius: 15px;
            width: 100%;
            max-width: 350px;
        }

        .upload-modal-content h3 {
            margin: 0 0 15px;
            color: #2c3e50;
            font-size: 16px;
            text-align: center;
        }

        .preview-image {
            width: 100%;
            height: 150px;
            object-fit: contain;
            border-radius: 8px;
            background: #f5f5f5;
            margin-bottom: 15px;
        }

        .form-group { margin-bottom: 15px; }

        .form-group label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            text-align: left;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
        }

        .form-group input:focus { outline: none; border-color: #667eea; }

        .system-warning {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            font-size: 11px;
            margin-bottom: 15px;
        }

        .counter {
            text-align: center;
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
            background: #f0f0f0;
            padding: 5px;
            border-radius: 5px;
        }

        .modal-buttons { display: flex; gap: 10px; }
        .modal-buttons .btn { flex: 1; }

        .empty-state {
            color: white;
            padding: 40px 20px;
            text-align: center;
        }
        .empty-state .icon { font-size: 50px; }

        .backup-section {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            border: 2px dashed #bdc3c7;
        }

        .backup-modal {
            display: none;
            position: fixed;
            z-index: 1002;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            justify-content: center;
            align-items: center;
            padding: 15px;
        }
        .backup-modal.show { display: flex; }

        .backup-modal-content {
            background: white;
            padding: 25px;
            border-radius: 15px;
            width: 100%;
            max-width: 350px;
            text-align: center;
        }

        .backup-modal-content h3 {
            margin: 0 0 20px;
            color: #2c3e50;
            font-size: 18px;
        }

        .backup-icon { font-size: 50px; margin-bottom: 15px; }
        .backup-status { font-size: 13px; color: #666; margin: 10px 0; }

        .total-results {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .total-results .count {
            font-size: 18px;
            font-weight: bold;
        }

        .total-results .actions {
            display: flex;
            gap: 8px;
        }

        .total-results .actions .btn {
            width: auto;
            padding: 8px 15px;
            margin: 0;
            font-size: 12px;
        }

        @media (min-width: 768px) {
            .gallery { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); }
            .image-item img { height: 130px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñºÔ∏è ‡Æ™‡Æü‡Æ§‡Øç ‡Æ§‡Øá‡Æü‡Æ≤‡Øç ‡ÆÜ‡Æ™‡Øç</h1>
        
        <div class="stats-bar">
            <span>üì∑ <span id="totalImages">0</span></span>
            <span>üíæ <span id="storageUsed">0 MB</span></span>
        </div>
        
        <div class="section">
            <div class="section-title">üì§ ‡Æ™‡Æü‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æö‡Øá‡Æ∞‡Øç</div>
            <input type="file" id="fileInput" accept="image/*" multiple>
            <label for="fileInput" class="btn btn-success">üì∑ ‡Æ™‡Æü‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ</label>
            
            <div id="selectedInfo" class="selected-info hidden"></div>
            <button id="uploadBtn" class="btn btn-primary" disabled>‚¨ÜÔ∏è ‡Æ™‡Æ§‡Æø‡Æµ‡Øá‡Æ±‡Øç‡Æ±‡ØÅ</button>
            
            <div id="progressSection" class="hidden">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
                <div id="progressText" class="progress-text"></div>
            </div>
        </div>

        <div class="section backup-section">
            <div class="section-title">üíæ Backup / Restore</div>
            <input type="file" id="restoreInput" accept=".zip">
            
            <div class="btn-grid">
                <button id="backupBtn" class="btn btn-purple">üì¶ Backup</button>
                <label for="restoreInput" class="btn btn-teal">üì• Restore</label>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">üîç Multiple Search</div>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="rohit, virat, bumrah, tilak...">
                <button class="clear-btn" id="clearSearchBtn">‚úï</button>
            </div>
            <div class="search-hint">
                üí° Comma (,) ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ space ‡Æâ‡Æü‡Æ©‡Øç ‡Æ™‡Æ≤ ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç‡Æï‡Æ≥‡Øà ‡Æ§‡Øá‡Æü‡Æ≤‡Ææ‡ÆÆ‡Øç
            </div>
            <div id="searchTags" class="search-tags"></div>
            
            <div class="btn-row" style="margin-top: 10px;">
                <button id="clearAllBtn" class="btn btn-danger">üóëÔ∏è ‡ÆÖ‡Æ©‡Øà‡Æ§‡Øç‡Æ§‡ØÅ‡ÆÆ‡Øç ‡ÆÖ‡Æ¥‡Æø</button>
            </div>
        </div>

        <!-- Total Results Bar -->
        <div id="totalResults" class="total-results hidden">
            <div>
                <span>üîç ‡Æ§‡Øá‡Æü‡Æ≤‡Øç ‡ÆÆ‡ØÅ‡Æü‡Æø‡Æµ‡ØÅ‡Æï‡Æ≥‡Øç:</span>
                <span id="totalFoundCount" class="count">0</span>
            </div>
            <div class="actions">
                <button id="downloadAllResults" class="btn btn-warning">‚¨áÔ∏è ‡ÆÖ‡Æ©‡Øà‡Æ§‡Øç‡Æ§‡ØÅ‡ÆÆ‡Øç</button>
            </div>
        </div>
        
        <div id="gallery" class="gallery"></div>
        
        <div id="emptyState" class="empty-state">
            <div class="icon">üì∑</div>
            <p>‡Æ™‡Æü‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà</p>
        </div>
        
        <p id="status" class="status">üîÑ ‡Æ§‡ÆØ‡Ææ‡Æ∞‡Ææ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...</p>
    </div>

    <div id="imageModal" class="modal">
        <span class="modal-close" id="modalClose">√ó</span>
        <img id="modalImage" src="">
        <div id="modalFilename" class="modal-filename"></div>
        <div class="modal-actions">
            <button id="modalDownload" class="btn btn-success">‚¨áÔ∏è</button>
            <button id="modalDelete" class="btn btn-danger">üóëÔ∏è</button>
        </div>
    </div>

    <div id="uploadModal" class="upload-modal">
        <div class="upload-modal-content">
            <h3>üìù ‡Æ™‡Æü‡Æ§‡Øç‡Æ§‡Æø‡Æ©‡Øç ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç</h3>
            <div id="uploadCounter" class="counter"></div>
            <img id="previewImage" class="preview-image">
            <div id="systemWarning" class="system-warning hidden">
                ‚ö†Ô∏è System ID: <span id="systemName"></span>
            </div>
            <div class="form-group">
                <label>üìÑ ‡Æ™‡Æü‡Æ§‡Øç‡Æ§‡Æø‡Æ©‡Øç ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç *</label>
                <input type="text" id="imageNameInput" placeholder="‡Æâ‡Æ§‡Ææ: Tilak Varma">
            </div>
            <div class="modal-buttons">
                <button id="skipBtn" class="btn btn-warning">‚è≠Ô∏è ‡Æ§‡Æµ‡Æø‡Æ∞‡Øç</button>
                <button id="saveBtn" class="btn btn-success">‚úÖ ‡Æö‡Øá‡ÆÆ‡Æø</button>
            </div>
        </div>
    </div>

    <div id="backupModal" class="backup-modal">
        <div class="backup-modal-content">
            <div id="backupIcon" class="backup-icon">üì¶</div>
            <h3 id="backupTitle">Backup...</h3>
            <div class="progress-bar">
                <div id="backupProgress" class="progress-fill backup"></div>
            </div>
            <p id="backupStatus" class="backup-status"></p>
        </div>
    </div>

    <div id="restoreModal" class="backup-modal">
        <div class="backup-modal-content">
            <div id="restoreIcon" class="backup-icon">üì•</div>
            <h3 id="restoreTitle">Restore...</h3>
            <div class="progress-bar">
                <div id="restoreProgress" class="progress-fill restore"></div>
            </div>
            <p id="restoreStatus" class="backup-status"></p>
        </div>
    </div>

    <script>
    (function() {
        class ImageDB {
            constructor() {
                this.dbName = 'PhotoAppDB3';
                this.storeName = 'images';
                this.db = null;
            }

            async open() {
                if (this.db) return;
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open(this.dbName, 1);
                    req.onerror = () => reject(req.error);
                    req.onsuccess = () => { this.db = req.result; resolve(); };
                    req.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            db.createObjectStore(this.storeName, { keyPath: 'id', autoIncrement: true });
                        }
                    };
                });
            }

            async add(data) {
                await this.open();
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction([this.storeName], 'readwrite');
                    const req = tx.objectStore(this.storeName).add(data);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            }

            async getAll() {
                await this.open();
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction([this.storeName], 'readonly');
                    const req = tx.objectStore(this.storeName).getAll();
                    req.onsuccess = () => resolve(req.result || []);
                    req.onerror = () => reject(req.error);
                });
            }

            async get(id) {
                await this.open();
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction([this.storeName], 'readonly');
                    const req = tx.objectStore(this.storeName).get(id);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            }

            async delete(id) {
                await this.open();
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction([this.storeName], 'readwrite');
                    const req = tx.objectStore(this.storeName).delete(id);
                    req.onsuccess = () => resolve();
                    req.onerror = () => reject(req.error);
                });
            }

            async clear() {
                await this.open();
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction([this.storeName], 'readwrite');
                    const req = tx.objectStore(this.storeName).clear();
                    req.onsuccess = () => resolve();
                    req.onerror = () => reject(req.error);
                });
            }
        }

        class App {
            constructor() {
                this.db = new ImageDB();
                this.images = [];
                this.queue = [];
                this.queueIndex = 0;
                this.previewUrl = null;
                this.modalImageId = null;
                this.searchTerms = [];
                this.searchResults = {};
                this.init();
            }

            $(id) { return document.getElementById(id); }

            async init() {
                try {
                    await this.db.open();
                    await this.loadImages();
                    this.bindEvents();
                    this.status('‚úÖ ‡ÆÜ‡Æ™‡Øç ‡Æ§‡ÆØ‡Ææ‡Æ∞‡Øç!');
                } catch (e) {
                    this.status('‚ùå Error: ' + e.message);
                }
            }

            bindEvents() {
                this.$('fileInput').onchange = (e) => this.onFilesSelected(e.target.files);
                this.$('uploadBtn').onclick = () => this.startUpload();
                
                // ‚úÖ Multiple Search
                let searchTimeout;
                this.$('searchInput').oninput = (e) => {
                    clearTimeout(searchTimeout);
                    const v = e.target.value.trim();
                    this.$('clearSearchBtn').classList.toggle('show', v.length > 0);
                    
                    searchTimeout = setTimeout(() => {
                        this.multiSearch(v);
                    }, 300);
                };
                
                this.$('searchInput').onkeypress = (e) => {
                    if (e.key === 'Enter') {
                        this.multiSearch(this.$('searchInput').value.trim());
                    }
                };
                
                this.$('clearSearchBtn').onclick = () => {
                    this.$('searchInput').value = '';
                    this.$('clearSearchBtn').classList.remove('show');
                    this.searchTerms = [];
                    this.searchResults = {};
                    this.updateSearchTags();
                    this.renderGallery(this.images);
                    this.$('totalResults').classList.add('hidden');
                };
                
                this.$('clearAllBtn').onclick = () => this.clearAll();
                this.$('downloadAllResults').onclick = () => this.downloadAllResults();
                
                this.$('saveBtn').onclick = () => this.saveImage();
                this.$('skipBtn').onclick = () => this.skipImage();
                this.$('imageNameInput').onkeypress = (e) => { if (e.key === 'Enter') this.saveImage(); };
                
                this.$('modalClose').onclick = () => this.closeModal();
                this.$('imageModal').onclick = (e) => { if (e.target === e.currentTarget) this.closeModal(); };
                this.$('modalDownload').onclick = () => this.downloadImage(this.modalImageId);
                this.$('modalDelete').onclick = () => { this.deleteImage(this.modalImageId); this.closeModal(); };

                this.$('backupBtn').onclick = () => this.createBackup();
                this.$('restoreInput').onchange = (e) => {
                    if (e.target.files[0]) this.restoreBackup(e.target.files[0]);
                };
            }

            // ==================== MULTI SEARCH ====================
            multiSearch(query) {
                if (!query) {
                    this.searchTerms = [];
                    this.searchResults = {};
                    this.updateSearchTags();
                    this.renderGallery(this.images);
                    this.$('totalResults').classList.add('hidden');
                    return;
                }

                // ‚úÖ Split by comma, space, or both
                // "rohit sharma, virat kohli, bumrah" -> ["rohit sharma", "virat kohli", "bumrah"]
                // "rohit virat bumrah" -> ["rohit", "virat", "bumrah"]
                
                let terms = [];
                
                if (query.includes(',')) {
                    // Comma separated - each part is one search term
                    terms = query.split(',').map(t => t.trim().toLowerCase()).filter(t => t);
                } else {
                    // Space separated - each word is one search term
                    terms = query.split(/\s+/).map(t => t.trim().toLowerCase()).filter(t => t);
                }

                // Remove duplicates
                this.searchTerms = [...new Set(terms)];
                
                this.updateSearchTags();
                this.performSearch();
            }

            updateSearchTags() {
                const container = this.$('searchTags');
                container.innerHTML = '';

                this.searchTerms.forEach((term, index) => {
                    const tag = document.createElement('span');
                    tag.className = 'search-tag';
                    tag.innerHTML = `
                        ${term}
                        <button class="remove" data-index="${index}">√ó</button>
                    `;
                    
                    tag.querySelector('.remove').onclick = () => {
                        this.searchTerms.splice(index, 1);
                        this.updateSearchTags();
                        this.performSearch();
                        
                        // Update input
                        this.$('searchInput').value = this.searchTerms.join(', ');
                    };
                    
                    container.appendChild(tag);
                });
            }

            performSearch() {
                if (this.searchTerms.length === 0) {
                    this.renderGallery(this.images);
                    this.$('totalResults').classList.add('hidden');
                    return;
                }

                this.searchResults = {};
                let totalFound = 0;
                const foundIds = new Set();

                // Search for each term
                this.searchTerms.forEach(term => {
                    this.searchResults[term] = [];
                    
                    this.images.forEach(img => {
                        const filename = img.filename.toLowerCase();
                        
                        if (filename.includes(term)) {
                            this.searchResults[term].push(img);
                            
                            if (!foundIds.has(img.id)) {
                                foundIds.add(img.id);
                                totalFound++;
                            }
                        }
                    });
                });

                this.displaySearchResults(totalFound);
            }

            displaySearchResults(totalFound) {
                const gallery = this.$('gallery');
                gallery.innerHTML = '';

                // Show total results bar
                if (totalFound > 0) {
                    this.$('totalResults').classList.remove('hidden');
                    this.$('totalFoundCount').textContent = totalFound;
                } else {
                    this.$('totalResults').classList.add('hidden');
                }

                // Group by search term
                let hasResults = false;

                this.searchTerms.forEach(term => {
                    const results = this.searchResults[term] || [];
                    
                    if (results.length > 0) {
                        hasResults = true;

                        const group = document.createElement('div');
                        group.className = 'search-group';
                        group.dataset.term = term;
                        
                        group.innerHTML = `
                            <div class="search-group-header">
                                <h3>üîç "${term}"</h3>
                                <div>
                                    <span class="count-badge">${results.length} ‡Æ™‡Æü‡Æô‡Øç‡Æï‡Æ≥‡Øç</span>
                                    <button class="download-group-btn" data-term="${term}">‚¨áÔ∏è ‡Æá‡Æµ‡Æ±‡Øç‡Æ±‡Øà ‡Æ™‡Æ§‡Æø‡Æµ‡Æø‡Æ±‡Æï‡Øç‡Æï‡ØÅ</button>
                                </div>
                            </div>
                        `;

                        const grid = document.createElement('div');
                        grid.className = 'gallery';
                        
                        results.forEach(img => {
                            grid.appendChild(this.createCard(img, term));
                        });

                        group.appendChild(grid);
                        gallery.appendChild(group);

                        // Download group button
                        group.querySelector('.download-group-btn').onclick = () => {
                            this.downloadGroup(term);
                        };
                    }
                });

                // No results
                if (!hasResults) {
                    this.$('emptyState').classList.remove('hidden');
                    gallery.innerHTML = '';
                } else {
                    this.$('emptyState').classList.add('hidden');
                }

                this.status(`üîç ${this.searchTerms.length} ‡Æ§‡Øá‡Æü‡Æ≤‡Øç‡Æï‡Æ≥‡Øç - ${totalFound} ‡Æ™‡Æü‡Æô‡Øç‡Æï‡Æ≥‡Øç`);
            }

            async downloadGroup(term) {
                const results = this.searchResults[term] || [];
                if (results.length === 0) return;

                this.status(`‚è≥ "${term}" - ${results.length} ‡Æ™‡Æü‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ™‡Æ§‡Æø‡Æµ‡Æø‡Æ±‡Æï‡Øç‡Æï‡ÆÆ‡Øç...`);

                for (const img of results) {
                    await this.downloadImage(img.id);
                    await this.sleep(400);
                }

                this.status(`‚úÖ "${term}" - ${results.length} ‡Æ™‡Æü‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ™‡Æ§‡Æø‡Æµ‡Æø‡Æ±‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ©!`);
            }

            async downloadAllResults() {
                // Get all unique images from search results
                const allIds = new Set();
                const allImages = [];

                this.searchTerms.forEach(term => {
                    (this.searchResults[term] || []).forEach(img => {
                        if (!allIds.has(img.id)) {
                            allIds.add(img.id);
                            allImages.push(img);
                        }
                    });
                });

                if (allImages.length === 0) return;

                this.status(`‚è≥ ${allImages.length} ‡Æ™‡Æü‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ™‡Æ§‡Æø‡Æµ‡Æø‡Æ±‡Æï‡Øç‡Æï‡ÆÆ‡Øç...`);

                for (const img of allImages) {
                    await this.downloadImage(img.id);
                    await this.sleep(400);
                }

                this.status(`‚úÖ ${allImages.length} ‡Æ™‡Æü‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ™‡Æ§‡Æø‡Æµ‡Æø‡Æ±‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ©!`);
            }

            // ==================== BACKUP ====================
            async createBackup() {
                if (this.images.length === 0) {
                    alert('üì≠ ‡Æ™‡Æü‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà!');
                    return;
                }

                this.$('backupModal').classList.add('show');
                this.$('backupIcon').textContent = 'üì¶';
                this.$('backupTitle').textContent = 'Backup...';
                this.$('backupProgress').style.width = '0%';
                this.$('backupStatus').textContent = '‡Æ§‡ÆØ‡Ææ‡Æ∞‡Ææ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...';

                try {
                    const zip = new JSZip();
                    const total = this.images.length;

                    for (let i = 0; i < total; i++) {
                        const img = this.images[i];
                        const percent = ((i + 1) / total) * 100;
                        
                        this.$('backupProgress').style.width = percent + '%';
                        this.$('backupStatus').textContent = `${i + 1}/${total}: ${img.filename}`;

                        const arrayBuffer = await img.blob.arrayBuffer();
                        zip.file(img.filename, arrayBuffer);

                        await this.sleep(30);
                    }

                    this.$('backupStatus').textContent = 'ZIP ‡Æâ‡Æ∞‡ØÅ‡Æµ‡Ææ‡Æï‡Øç‡Æï‡ÆÆ‡Øç...';

                    const zipBlob = await zip.generateAsync({ 
                        type: 'blob',
                        compression: 'DEFLATE',
                        compressionOptions: { level: 6 }
                    });

                    const date = new Date().toISOString().split('T')[0];
                    const filename = `photos_backup_${date}.zip`;
                    
                    const url = URL.createObjectURL(zipBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(url);

                    this.$('backupIcon').textContent = '‚úÖ';
                    this.$('backupTitle').textContent = '‡Æµ‡ØÜ‡Æ±‡Øç‡Æ±‡Æø!';
                    this.$('backupStatus').textContent = `${total} ‡Æ™‡Æü‡Æô‡Øç‡Æï‡Æ≥‡Øç - ${(zipBlob.size / 1024 / 1024).toFixed(2)} MB`;

                    setTimeout(() => this.$('backupModal').classList.remove('show'), 2000);

                } catch (e) {
                    this.$('backupIcon').textContent = '‚ùå';
                    this.$('backupTitle').textContent = '‡Æ§‡Øã‡Æ≤‡Øç‡Æµ‡Æø!';
                    this.$('backupStatus').textContent = e.message;
                    setTimeout(() => this.$('backupModal').classList.remove('show'), 3000);
                }
            }

            // ==================== RESTORE ====================
            async restoreBackup(file) {
                this.$('restoreModal').classList.add('show');
                this.$('restoreIcon').textContent = 'üì•';
                this.$('restoreTitle').textContent = 'Restore...';
                this.$('restoreProgress').style.width = '0%';
                this.$('restoreStatus').textContent = '‡Æ™‡Æü‡Æø‡Æï‡Øç‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...';

                try {
                    const zip = await JSZip.loadAsync(file);
                    const allFiles = Object.keys(zip.files);
                    
                    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp'];
                    const imageFiles = allFiles.filter(name => {
                        if (zip.files[name].dir) return false;
                        const lowerName = name.toLowerCase();
                        return imageExtensions.some(ext => lowerName.endsWith(ext));
                    });

                    if (imageFiles.length === 0) {
                        throw new Error('‡Æ™‡Æü‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà!');
                    }

                    const total = imageFiles.length;
                    let restored = 0;

                    for (let i = 0; i < total; i++) {
                        const filePath = imageFiles[i];
                        const filename = filePath.split('/').pop();
                        
                        this.$('restoreProgress').style.width = ((i + 1) / total * 100) + '%';
                        this.$('restoreStatus').textContent = `${i + 1}/${total}: ${filename}`;

                        try {
                            const data = await zip.files[filePath].async('arraybuffer');
                            const ext = filename.split('.').pop().toLowerCase();
                            const mimeTypes = {
                                'jpg': 'image/jpeg', 'jpeg': 'image/jpeg',
                                'png': 'image/png', 'gif': 'image/gif',
                                'webp': 'image/webp', 'bmp': 'image/bmp'
                            };
                            const blob = new Blob([data], { type: mimeTypes[ext] || 'image/jpeg' });

                            await this.db.add({
                                blob, filename,
                                size: blob.size,
                                date: Date.now()
                            });
                            restored++;
                        } catch (e) {
                            console.error('Error:', filePath, e);
                        }

                        await this.sleep(30);
                    }

                    this.$('restoreIcon').textContent = '‚úÖ';
                    this.$('restoreTitle').textContent = '‡Æµ‡ØÜ‡Æ±‡Øç‡Æ±‡Æø!';
                    this.$('restoreStatus').textContent = `${restored} ‡Æ™‡Æü‡Æô‡Øç‡Æï‡Æ≥‡Øç`;

                    await this.loadImages();
                    setTimeout(() => this.$('restoreModal').classList.remove('show'), 2000);

                } catch (e) {
                    this.$('restoreIcon').textContent = '‚ùå';
                    this.$('restoreTitle').textContent = '‡Æ§‡Øã‡Æ≤‡Øç‡Æµ‡Æø!';
                    this.$('restoreStatus').textContent = e.message;
                    setTimeout(() => this.$('restoreModal').classList.remove('show'), 3000);
                }

                this.$('restoreInput').value = '';
            }

            // ==================== UPLOAD ====================
            isSystemId(name) {
                const base = name.replace(/\.[^.]+$/, '');
                return /^\d+$/.test(base);
            }

            getExt(name) {
                const m = name.match(/\.[^.]+$/);
                return m ? m[0] : '.jpg';
            }

            onFilesSelected(files) {
                if (!files || files.length === 0) return;
                
                this.queue = Array.from(files).filter(f => f.type.startsWith('image/'));
                
                if (this.queue.length === 0) {
                    this.status('‚ùå ‡Æ™‡Æü‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà');
                    return;
                }
                
                this.$('selectedInfo').textContent = `üìÅ ${this.queue.length} ‡Æ™‡Æü‡Æô‡Øç‡Æï‡Æ≥‡Øç`;
                this.$('selectedInfo').classList.remove('hidden');
                this.$('uploadBtn').disabled = false;
            }

            startUpload() {
                if (this.queue.length === 0) return;
                this.queueIndex = 0;
                this.$('uploadBtn').disabled = true;
                this.$('progressSection').classList.remove('hidden');
                this.showUploadModal();
            }

            showUploadModal() {
                if (this.queueIndex >= this.queue.length) {
                    this.finishUpload();
                    return;
                }
                
                const file = this.queue[this.queueIndex];
                const total = this.queue.length;
                const current = this.queueIndex + 1;
                
                this.$('progressFill').style.width = (current / total * 100) + '%';
                this.$('progressText').textContent = `${current}/${total}`;
                this.$('uploadCounter').textContent = `‡Æ™‡Æü‡ÆÆ‡Øç ${current}/${total}`;
                
                if (this.previewUrl) URL.revokeObjectURL(this.previewUrl);
                this.previewUrl = URL.createObjectURL(file);
                this.$('previewImage').src = this.previewUrl;
                
                if (this.isSystemId(file.name)) {
                    this.$('systemWarning').classList.remove('hidden');
                    this.$('systemName').textContent = file.name;
                    this.$('imageNameInput').value = '';
                } else {
                    this.$('systemWarning').classList.add('hidden');
                    this.$('imageNameInput').value = file.name.replace(/\.[^.]+$/, '');
                }
                
                this.$('uploadModal').classList.add('show');
                setTimeout(() => this.$('imageNameInput').focus(), 100);
            }

            async saveImage() {
                const file = this.queue[this.queueIndex];
                let name = this.$('imageNameInput').value.trim();
                
                if (!name) {
                    alert('üìõ ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æø‡Æü‡Æµ‡ØÅ‡ÆÆ‡Øç!');
                    return;
                }
                
                const ext = this.getExt(file.name);
                if (!name.includes('.')) name += ext;
                
                await this.saveFile(file, name);
                this.queueIndex++;
                this.showUploadModal();
            }

            async skipImage() {
                const file = this.queue[this.queueIndex];
                const ext = this.getExt(file.name);
                const name = this.isSystemId(file.name) ? `Image_${Date.now()}${ext}` : file.name;
                
                await this.saveFile(file, name);
                this.queueIndex++;
                this.showUploadModal();
            }

            async saveFile(file, filename) {
                try {
                    const buffer = await file.arrayBuffer();
                    const blob = new Blob([buffer], { type: file.type });
                    
                    await this.db.add({
                        blob, filename,
                        size: file.size,
                        date: Date.now()
                    });
                } catch (e) {
                    console.error('Save error:', e);
                }
            }

            async finishUpload() {
                this.$('uploadModal').classList.remove('show');
                const count = this.queue.length;
                
                this.$('progressSection').classList.add('hidden');
                this.$('selectedInfo').classList.add('hidden');
                this.$('fileInput').value = '';
                this.$('uploadBtn').disabled = true;
                
                this.queue = [];
                if (this.previewUrl) URL.revokeObjectURL(this.previewUrl);
                
                await this.loadImages();
                this.status(`‚úÖ ${count} ‡Æ™‡Æü‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æö‡Øá‡ÆÆ‡Æø‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ©!`);
            }

            // ==================== GALLERY ====================
            async loadImages() {
                this.images = await this.db.getAll();
                this.images.sort((a, b) => (b.date || 0) - (a.date || 0));
                this.renderGallery(this.images);
                this.updateStats();
            }

            renderGallery(images) {
                const gallery = this.$('gallery');
                gallery.innerHTML = '';
                
                this.$('emptyState').classList.toggle('hidden', images.length > 0);
                this.$('totalResults').classList.add('hidden');
                this.$('backupBtn').disabled = images.length === 0;
                
                images.forEach(img => gallery.appendChild(this.createCard(img)));
            }

            createCard(img, highlightTerm = null) {
                const card = document.createElement('div');
                card.className = 'image-item';
                card.dataset.id = img.id;
                
                const url = URL.createObjectURL(img.blob);
                
                // Highlight matching term in filename
                let displayName = img.filename;
                if (highlightTerm) {
                    const regex = new RegExp(`(${highlightTerm})`, 'gi');
                    displayName = img.filename.replace(regex, '<mark style="background:#ffd700;padding:0 2px;border-radius:2px;">$1</mark>');
                }
                
                card.innerHTML = `
                    <img src="${url}" loading="lazy">
                    <div class="filename">${displayName}</div>
                    <div class="btn-group">
                        <button class="btn btn-success">‚¨áÔ∏è</button>
                        <button class="btn btn-danger">üóëÔ∏è</button>
                    </div>
                `;
                
                card.querySelector('img').onclick = () => this.openModal(img.id, url, img.filename);
                card.querySelectorAll('.btn-group .btn')[0].onclick = (e) => { e.stopPropagation(); this.downloadImage(img.id); };
                card.querySelectorAll('.btn-group .btn')[1].onclick = (e) => { e.stopPropagation(); this.deleteImage(img.id, card); };
                
                return card;
            }

            openModal(id, url, filename) {
                this.modalImageId = id;
                this.$('modalImage').src = url;
                this.$('modalFilename').textContent = 'üìÑ ' + filename;
                this.$('imageModal').classList.add('show');
            }

            closeModal() {
                this.$('imageModal').classList.remove('show');
            }

            async downloadImage(id) {
                const img = await this.db.get(id);
                if (!img) return;
                
                const url = URL.createObjectURL(img.blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = img.filename;
                a.click();
                URL.revokeObjectURL(url);
            }

            async deleteImage(id, card = null) {
                const img = await this.db.get(id);
                if (!img || !confirm(`"${img.filename}" ‡ÆÖ‡Æ¥‡Æø‡Æï‡Øç‡Æï‡Æµ‡Ææ?`)) return;
                
                await this.db.delete(id);
                if (card) card.remove();
                
                this.images = this.images.filter(i => i.id !== id);
                this.updateStats();
                
                if (this.images.length === 0) this.$('emptyState').classList.remove('hidden');
            }

            async clearAll() {
                if (this.images.length === 0) return;
                if (!confirm(`‚ö†Ô∏è ${this.images.length} ‡Æ™‡Æü‡Æô‡Øç‡Æï‡Æ≥‡Øà ‡ÆÖ‡Æ¥‡Æø‡Æï‡Øç‡Æï‡Æµ‡Ææ?`)) return;
                
                await this.db.clear();
                this.images = [];
                this.$('gallery').innerHTML = '';
                this.$('emptyState').classList.remove('hidden');
                this.$('totalResults').classList.add('hidden');
                this.updateStats();
            }

            updateStats() {
                this.$('totalImages').textContent = this.images.length;
                const mb = (this.images.reduce((s, i) => s + (i.size || 0), 0) / 1024 / 1024).toFixed(2);
                this.$('storageUsed').textContent = mb + ' MB';
            }

            status(msg) { this.$('status').textContent = msg; }
            sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
        }

        new App();
    })();
    </script>
</body>
</html>
